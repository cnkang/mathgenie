name: 🤖 Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize]

# Only run on Dependabot PRs
concurrency:
  group: dependabot-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Job 1: Dependabot PR Analysis
  dependabot-analysis:
    name: 🔍 Dependabot Analysis
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write

    outputs:
      auto_merge: ${{ steps.analysis.outputs.auto_merge }}
      update_type: ${{ steps.analysis.outputs.update_type }}

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Analyze Dependabot PR
        id: analysis
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();

            // Determine update type
            let updateType = 'unknown';
            if (title.includes('patch')) updateType = 'patch';
            else if (title.includes('minor')) updateType = 'minor';
            else if (title.includes('major')) updateType = 'major';

            // Auto-merge criteria
            const autoMerge = updateType === 'patch' || 
                             (updateType === 'minor' && !title.includes('breaking'));

            core.exportVariable('update_type', updateType);
            core.exportVariable('auto_merge', autoMerge.toString());
            
            // Use environment file for outputs (GitHub Actions new method)
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `update_type=${updateType}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `auto_merge=${autoMerge.toString()}\n`);

            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['dependencies', `${updateType}-update`]
            });

            // Add comment with analysis
            const comment = `
            ## 🤖 Dependabot PR Analysis

            - **Update Type**: ${updateType}
            - **Auto-merge Eligible**: ${autoMerge ? '✅ Yes' : '❌ No'}

            ${autoMerge ? 
              '✅ This PR will be auto-merged after CI passes.' : 
              '⚠️ This PR requires manual review due to potential breaking changes.'
            }
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });

  # Job 2: Run CI for Dependabot PRs
  dependabot-ci:
    name: 🧪 Dependabot CI
    runs-on: ubuntu-latest
    needs: dependabot-analysis
    if: github.actor == 'dependabot[bot]'
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@2270f39ef63c3edf50be34da68c039eca5e15c15
        with:
          version: '10.15.1'

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: 📋 Install dependencies
        run: pnpm install --frozen-lockfile

      - name: 🔍 Run linting
        run: pnpm lint

      - name: 🧪 Run tests
        run: pnpm test:unit

      - name: 🏗️ Build application
        run: pnpm build

      - name: 🔒 Security audit
        run: pnpm audit --audit-level moderate
        continue-on-error: true

  # Job 3: Auto-merge eligible PRs
  dependabot-auto-merge:
    name: 🔄 Auto-merge
    runs-on: ubuntu-latest
    needs: [dependabot-analysis, dependabot-ci]
    if: |
      github.actor == 'dependabot[bot]' && 
      needs.dependabot-analysis.outputs.auto_merge == 'true' &&
      needs.dependabot-ci.result == 'success'
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 🤖 Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Enable auto-merge
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'APPROVE',
              body: '🤖 Auto-approved by Dependabot workflow after successful CI checks.'
            });

            // Enable auto-merge with squash
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'APPROVE'
            });

            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: 'Auto-merged by Dependabot workflow'
              });
              
              console.log('✅ PR auto-merged successfully');
            } catch (error) {
              console.log('❌ Failed to auto-merge:', error.message);
              
              // Comment on failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `❌ Auto-merge failed: ${error.message}\n\nPlease merge manually.`
              });
            }

  # Job 4: Notify on manual review required
  dependabot-manual-review:
    name: 📢 Manual Review Required
    runs-on: ubuntu-latest
    needs: [dependabot-analysis, dependabot-ci]
    if: |
      github.actor == 'dependabot[bot]' && 
      needs.dependabot-analysis.outputs.auto_merge == 'false' &&
      needs.dependabot-ci.result == 'success'
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: 📢 Request manual review
        uses: actions/github-script@v7
        env:
          UPDATE_TYPE: ${{ needs.dependabot-analysis.outputs.update_type }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const updateType = process.env.UPDATE_TYPE;

            // Request review from maintainers (update with actual GitHub usernames)
            const maintainers = []; // Add actual maintainer usernames here

            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: maintainers
              });
            } catch (error) {
              console.log('Could not request reviewers:', error.message);
            }

            // Add comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `
              ## 👀 Manual Review Required
              
              This Dependabot PR requires manual review due to:
              - **Update Type**: ${updateType}
              - **Potential Breaking Changes**: This update may introduce breaking changes
              
              Please review the changes carefully before merging.
              
              ✅ **CI Status**: All checks passed
              `
            });

  # Job 5: Handle CI failures
  dependabot-ci-failure:
    name: ❌ CI Failure Handler
    runs-on: ubuntu-latest
    needs: [dependabot-analysis, dependabot-ci]
    if: |
      github.actor == 'dependabot[bot]' && 
      needs.dependabot-ci.result == 'failure'
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: ❌ Handle CI failure
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `
              ## ❌ CI Checks Failed
              
              The automated CI checks have failed for this Dependabot PR.
              
              **Next Steps:**
              1. Review the failed checks in the Actions tab
              2. Determine if the failure is related to the dependency update
              3. If it's a legitimate issue, consider:
                 - Updating the dependency manually with fixes
                 - Skipping this update temporarily
                 - Investigating compatibility issues
              
              **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `
            });

            // Add failure label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ci-failure', 'needs-investigation']
            });

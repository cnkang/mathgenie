#!/bin/sh
# Ensure consistent color output in CI environments
export NO_COLOR=1

echo "🚀 Running pre-push checks..."

if git diff --cached --name-only | grep -q '^\.git/'; then
  echo "❌ Abort: trying to commit files under .git/"
  exit 1
fi

# 获取当前分支
current_branch=$(git branch --show-current)
echo "📍 Current branch: $current_branch"

# 检查是否在main或develop分支上直接push
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
  echo "⚠️  Pushing directly to $current_branch branch"
  echo "Consider using pull requests for better code review"
fi

# 运行类型检查
echo "🔍 Running TypeScript type check..."
if ! pnpm type-check; then
  echo "❌ TypeScript type check failed"
  exit 1
fi

# 运行国际化检查
echo "🌍 Running i18n checks..."
if ! pnpm i18n:check; then
  echo "❌ i18n checks failed"
  exit 1
fi

# 运行CSS和HTML质量检查（不自动修复，确保代码质量）
echo "🎨 Running CSS & HTML quality checks..."
if ! pnpm lint:css-html; then
  echo "❌ CSS & HTML quality checks failed"
  echo "💡 Run 'pnpm lint:css-html:fix' to auto-fix issues"
  exit 1
fi

# 运行测试
echo "🧪 Running tests..."
if ! pnpm test:unit; then
  echo "❌ Unit tests failed"
  exit 1
fi

# 检查构建
echo "🏗️  Checking build..."
if ! pnpm build; then
  echo "❌ Build failed"
  exit 1
fi

# 检查是否有未提交的更改
if ! git diff --quiet; then
  echo "❌ You have unstaged changes. Please commit or stash them first."
  git status --porcelain
  exit 1
fi

if ! git diff --cached --quiet; then
  echo "❌ You have staged changes. Please commit them first."
  git status --porcelain
  exit 1
fi

echo "✅ Pre-push checks passed!"
#!/bin/sh
# Ensure consistent color output in CI environments
export NO_COLOR=1

echo "ğŸš€ Running pre-push checks..."

if git diff --cached --name-only | grep -q '^\.git/'; then
  echo "âŒ Abort: trying to commit files under .git/"
  exit 1
fi

# è·å–å½“å‰åˆ†æ”¯
current_branch=$(git branch --show-current)
echo "ğŸ“ Current branch: $current_branch"

# æ£€æŸ¥æ˜¯å¦åœ¨mainæˆ–developåˆ†æ”¯ä¸Šç›´æ¥push
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
  echo "âš ï¸  Pushing directly to $current_branch branch"
  echo "Consider using pull requests for better code review"
fi

# è¿è¡Œç±»å‹æ£€æŸ¥
echo "ğŸ” Running TypeScript type check..."
if ! pnpm type-check; then
  echo "âŒ TypeScript type check failed"
  exit 1
fi

# è¿è¡Œæµ‹è¯•
echo "ğŸ§ª Running tests..."
if ! pnpm test:unit; then
  echo "âŒ Unit tests failed"
  exit 1
fi

# æ£€æŸ¥æ„å»º
echo "ğŸ—ï¸  Checking build..."
if ! pnpm build; then
  echo "âŒ Build failed"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if ! git diff --quiet; then
  echo "âŒ You have unstaged changes. Please commit or stash them first."
  git status --porcelain
  exit 1
fi

if ! git diff --cached --quiet; then
  echo "âŒ You have staged changes. Please commit them first."
  git status --porcelain
  exit 1
fi

echo "âœ… Pre-push checks passed!"